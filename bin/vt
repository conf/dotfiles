#!/bin/bash
set -euo pipefail

unset VAULT_TOKEN # we don't care about expired tokens in the env
if vault token lookup >& /dev/null; then
	# all is good, our token is still valid
	cat ~/.vault-token
else
	credentials="$(op item get "$ONEPASS_VAULT_ID" --fields label=username,label=password)"
	IFS=, read username password <<< "$credentials"
	vault login -field=token -method=userpass username="$username" password="$password"
fi
